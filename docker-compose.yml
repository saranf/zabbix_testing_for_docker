version: '3.8'

services:
  # PostgreSQL Database
  postgres-server:
    image: postgres:15-alpine
    container_name: zabbix-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - zabbix-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Zabbix Server
  zabbix-server:
    image: zabbix/zabbix-server-pgsql:alpine-6.4-latest
    container_name: zabbix-server
    restart: unless-stopped
    environment:
      DB_SERVER_HOST: postgres-server
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      ZBX_ENABLE_SNMP_TRAPS: "true"
      ZBX_STARTPOLLERS: 5
      ZBX_STARTPOLLERSUNREACHABLE: 1
      ZBX_STARTTRAPPERS: 5
      ZBX_STARTPINGERS: 1
      ZBX_STARTDISCOVERERS: 1
      ZBX_STARTHTTPPOLLERS: 1
    ports:
      - "${ZABBIX_SERVER_PORT}:10051"
    volumes:
      - zabbix-server-data:/var/lib/zabbix
      - zabbix-snmptraps:/var/lib/zabbix/snmptraps
    networks:
      - zabbix-network
    depends_on:
      postgres-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "zabbix_server", "-R", "config_cache_reload"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Zabbix Web Interface (Nginx)
  zabbix-web:
    image: zabbix/zabbix-web-nginx-pgsql:alpine-6.4-latest
    container_name: zabbix-web
    restart: unless-stopped
    environment:
      ZBX_SERVER_HOST: zabbix-server
      DB_SERVER_HOST: postgres-server
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PHP_TZ: ${TIMEZONE}
      ZBX_SERVER_NAME: ${ZBX_SERVER_NAME}
    volumes:
      - zabbix-web-data:/usr/share/zabbix
    networks:
      - zabbix-network
    depends_on:
      - postgres-server
      - zabbix-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Reverse Proxy (Nginx with Security)
  zabbix-reverse-proxy:
    image: nginx:alpine
    container_name: zabbix-reverse-proxy
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      - nginx-logs:/var/log/nginx
    networks:
      - zabbix-network
    depends_on:
      - zabbix-web
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.zabbix.description=Reverse Proxy with Security Headers"
      - "com.zabbix.component=nginx"

  # Certbot for SSL Certificate (with cron)
  certbot:
    build:
      context: ./certbot
      dockerfile: Dockerfile
    container_name: zabbix-certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Nginx 재시작용 (선택사항)
    networks:
      - zabbix-network
    labels:
      - "com.zabbix.description=SSL Certificate Auto-Renewal"
      - "com.zabbix.component=security"

  # Firewall (iptables-based security)
  zabbix-firewall:
    build:
      context: ./firewall
      dockerfile: Dockerfile
    container_name: zabbix-firewall
    restart: unless-stopped
    network_mode: host
    environment:
      - SSH_PORT=${SSH_PORT:-22}
      - HTTP_PORT=${HTTP_PORT:-80}
      - HTTPS_PORT=${HTTPS_PORT:-443}
      - ZABBIX_SERVER_PORT=${ZABBIX_SERVER_PORT:-10847}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    privileged: true
    labels:
      - "com.zabbix.description=iptables Firewall"
      - "com.zabbix.component=security"

  # Zabbix Agent (for monitoring the Zabbix server itself)
  zabbix-agent:
    image: zabbix/zabbix-agent:alpine-6.4-latest
    container_name: zabbix-agent
    restart: unless-stopped
    environment:
      ZBX_HOSTNAME: "Zabbix server"
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
    networks:
      - zabbix-network
    depends_on:
      - zabbix-server

networks:
  zabbix-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  zabbix-server-data:
    driver: local
  zabbix-web-data:
    driver: local
  zabbix-snmptraps:
    driver: local
  nginx-logs:
    driver: local

